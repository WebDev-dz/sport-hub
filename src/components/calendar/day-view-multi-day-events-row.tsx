import {
	differenceInDays,
	endOfDay,
	isWithinInterval,
	parseISO,
	startOfDay,
} from "date-fns";
import type { IEvent } from "@/components/calendar/interfaces";
import { MonthEventBadge } from "@/components/calendar/month-event-badge";

interface IProps {
	selectedDate: Date;
	multiDayEvents: IEvent[];
}

export function DayViewMultiDayEventsRow({
	selectedDate,
	multiDayEvents,
}: IProps) {
	const dayStart = startOfDay(selectedDate);
	const dayEnd = endOfDay(selectedDate);

	const multiDayEventsInDay = multiDayEvents
		.filter((event) => {
			const eventStart = event.start;
			const eventEnd = event.end;

			return (
				isWithinInterval(dayStart, { start: eventStart, end: eventEnd }) ||
				isWithinInterval(dayEnd, { start: eventStart, end: eventEnd }) ||
				(eventStart <= dayStart && eventEnd >= dayEnd)
			);
		})
		.sort((a, b) => {
			const durationA = differenceInDays(
				a.end,
				a.start,
			);
			const durationB = differenceInDays(
				b.end,
				b.start,
			);
			return durationB - durationA;
		});

	if (multiDayEventsInDay.length === 0) return null;

	return (
		<div className="flex border-b">
			<div className="w-18"></div>
			<div className="flex flex-1 flex-col gap-1 border-l py-1">
				{multiDayEventsInDay.map((event) => {
					const eventStart = startOfDay((event.start));	
					const eventEnd = startOfDay((event.end));	
					const currentDate = startOfDay(selectedDate);

					const eventTotalDays = differenceInDays(eventEnd, eventStart) + 1;
					const eventCurrentDay = differenceInDays(currentDate, eventStart) + 1;

					return (
						<MonthEventBadge
							key={event.id}
							event={event}
							cellDate={selectedDate}
							eventCurrentDay={eventCurrentDay}
							eventTotalDays={eventTotalDays}
						/>
					);
				})}
			</div>
		</div>
	);
}
